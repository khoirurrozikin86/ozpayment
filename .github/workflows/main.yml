jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Write SSH key to file (secure)
        run: |
          umask 177
          cat > id_ci <<'EOF'
${{ secrets.SSH_PRIVATE_KEY }}
EOF
          # sanity check format header/footer
          head -n 1 id_ci | grep -q 'BEGIN OPENSSH PRIVATE KEY' || { echo "Key header invalid"; exit 1; }
          tail -n 1 id_ci | grep -q 'END OPENSSH PRIVATE KEY' || { echo "Key footer invalid"; exit 1; }

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}         # 103.175.216.94
          username: ${{ secrets.SSH_USER }}     # rozikin
          port: ${{ secrets.SSH_PORT }}         # 22
          key_path: id_ci                       # <— pakai file, bukan "key:"
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}  # kalau key ada passphrase
          script_stop: true
          debug: true
          script: |
            set -euo pipefail
            APP_DIR="/var/www/html/ozapi"
            REPO_URL="git@github.com:khoirurrozikin86/ozpayment.git"
            BRANCH="add_payment"
            export COMPOSER_MEMORY_LIMIT=-1
            export COMPOSER_ALLOW_SUPERUSER=1

            mkdir -p ~/.ssh && ssh-keyscan -H github.com >> ~/.ssh/known_hosts || true

            mkdir -p "$APP_DIR"
            [ -w "$APP_DIR" ] || { echo "no write permission to $APP_DIR"; exit 1; }
            cd "$APP_DIR"

            command -v git >/dev/null 2>&1 || { echo "git missing"; exit 1; }
            if [ ! -d ".git" ]; then
              git clone --branch "$BRANCH" --single-branch "$REPO_URL" "$APP_DIR"
            else
              git config --global --add safe.directory "$APP_DIR"
              git fetch origin "$BRANCH" --prune
              git reset --hard "origin/$BRANCH"
            fi

            if ! command -v composer >/dev/null 2>&1; then
              curl -sS https://getcomposer.org/installer | php
              mkdir -p "$HOME/.local/bin"
              mv composer.phar "$HOME/.local/bin/composer"
              chmod +x "$HOME/.local/bin/composer"
              export PATH="$HOME/.local/bin:$PATH"
            fi

            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            [ -f .env ] || { cp .env.example .env || true; echo "⚠️ .env created from example"; }
            php artisan key:generate || true
            php artisan migrate --force || true

            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan optimize || true
            php artisan storage:link || true

            echo "✅ Deploy selesai $(date)"
