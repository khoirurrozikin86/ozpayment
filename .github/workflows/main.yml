name: CI/CD Deploy ozpayment (no sudo)

on:
  push:
    branches: [ add_payment ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}      # contoh: 36.95.208.100
          username: ${{ secrets.SSH_USER }}  # contoh: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}      # contoh: 223
          script_stop: true
          debug: true
          script: |
            set -euo pipefail

            # ====== KONFIGURASI DASAR ======
            APP_DIR="/var/www/html/ozapi"
            REPO_URL="git@github.com:khoirurrozikin86/ozpayment.git"
            BRANCH="add_payment"
            export COMPOSER_MEMORY_LIMIT=-1
            export COMPOSER_ALLOW_SUPERUSER=1

            echo "=== [1/8] Siapkan folder kerja ==="
            mkdir -p "$APP_DIR"
            [ -w "$APP_DIR" ] || { echo "❌ Tidak bisa menulis ke $APP_DIR. Cek izin/owner."; exit 1; }

            cd "$APP_DIR"

            echo "=== [2/8] Setup repo ==="
            if [ ! -d ".git" ]; then
              echo "Belum ada repo, cloning..."
              git clone --branch "$BRANCH" --single-branch "$REPO_URL" "$APP_DIR"
            else
              echo "Repo sudah ada, update..."
              git config --global --add safe.directory "$APP_DIR"
              git fetch origin "$BRANCH" --prune
              git reset --hard "origin/$BRANCH"
            fi

            echo "=== [3/8] Pastikan Composer tersedia ==="
            if ! command -v composer >/dev/null 2>&1; then
              echo "Composer belum ada, install lokal..."
              curl -sS https://getcomposer.org/installer | php
              mkdir -p "$HOME/.local/bin"
              mv composer.phar "$HOME/.local/bin/composer"
              chmod +x "$HOME/.local/bin/composer"
              export PATH="$HOME/.local/bin:$PATH"
              grep -q 'export PATH="$HOME/.local/bin:$PATH"' "$HOME/.profile" 2>/dev/null || \
                echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.profile"
            fi

            echo "=== [4/8] Install dependencies (production) ==="
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            echo "=== [5/8] Siapkan environment ==="
            if [ ! -f .env ]; then
              cp .env.example .env || true
              echo "⚠️  File .env dibuat dari example. Pastikan variabel DB sudah benar."
            fi
            php artisan key:generate || true

            echo "=== [6/8] Jalankan migrasi ==="
            php artisan migrate --force || true

            echo "=== [7/8] Cache dan optimisasi ==="
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true

            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan optimize || true

            echo "=== [8/8] Storage link & selesai ==="
            php artisan storage:link || true

            echo "✅ Deploy ozpayment selesai pada $(date)"
